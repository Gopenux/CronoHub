#!/usr/bin/env node
// CronoHub - Automatic Issue Creation Script
// Author: Gopenux AI
// Copyright (c) 2026 Gopenux AI

const https = require('https');

/**
 * Creates a GitHub issue when tests fail
 * @param {Object} params - Issue parameters
 */
async function createIssue(params) {
  const {
    owner,
    repo,
    token,
    testName,
    errorMessage,
    errorStack,
    chromeVersion,
    runUrl,
    commitSha,
    runId,
    mentionUser
  } = params;

  const timestamp = new Date().toISOString();
  const issueTitle = `üî¥ Test Failure: ${testName} (Chrome ${chromeVersion})`;

  const issueBody = `## üö® Automated Test Failure Report

**Test Suite:** ${testName}
**Chrome Version:** ${chromeVersion}
**Timestamp:** ${timestamp}
**Commit:** ${commitSha}

${mentionUser ? `@${mentionUser}` : ''}

### ‚ùå Error Details

\`\`\`
${errorMessage}
\`\`\`

### üìã Stack Trace

\`\`\`
${errorStack || 'No stack trace available'}
\`\`\`

### üîó Links

- [GitHub Actions Run](${runUrl})
- [Commit Details](https://github.com/${owner}/${repo}/commit/${commitSha})

### üìä Context

This issue was automatically created by CronoHub's daily compatibility tests. The test failure indicates a potential compatibility issue with Chrome ${chromeVersion}.

### üîç Next Steps

1. Review the error message and stack trace above
2. Check the GitHub Actions logs for more details
3. Reproduce the issue locally with Chrome ${chromeVersion}
4. Fix the issue and verify tests pass
5. Close this issue once resolved

### ü§ñ Automation Info

- **Created by:** CronoHub Test Automation
- **Workflow:** Daily Chrome Compatibility Tests
- **Run ID:** ${runId}

---
<sub>This issue was automatically generated by CronoHub testing infrastructure</sub>
`;

  const postData = JSON.stringify({
    title: issueTitle,
    body: issueBody,
    labels: ['bug', 'automated-test', 'chrome-compatibility']
  });

  const options = {
    hostname: 'api.github.com',
    path: `/repos/${owner}/${repo}/issues`,
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      'Content-Length': postData.length,
      'User-Agent': 'CronoHub-Test-Bot'
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 201) {
          const issue = JSON.parse(data);
          console.log(`‚úÖ Issue created successfully: ${issue.html_url}`);
          resolve(issue);
        } else {
          console.error(`‚ùå Failed to create issue. Status: ${res.statusCode}`);
          console.error(`Response: ${data}`);
          reject(new Error(`Failed to create issue: ${res.statusCode}`));
        }
      });
    });

    req.on('error', (error) => {
      console.error('‚ùå Request error:', error);
      reject(error);
    });

    req.write(postData);
    req.end();
  });
}

/**
 * Checks if a similar issue already exists
 * @param {Object} params - Check parameters
 */
async function checkExistingIssue(params) {
  const { owner, repo, token, testName, chromeVersion } = params;

  const searchQuery = `repo:${owner}/${repo} is:issue is:open "${testName}" "Chrome ${chromeVersion}"`;
  const encodedQuery = encodeURIComponent(searchQuery);

  const options = {
    hostname: 'api.github.com',
    path: `/search/issues?q=${encodedQuery}`,
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json',
      'User-Agent': 'CronoHub-Test-Bot'
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 200) {
          const result = JSON.parse(data);
          resolve(result.total_count > 0 ? result.items[0] : null);
        } else {
          reject(new Error(`Failed to search issues: ${res.statusCode}`));
        }
      });
    });

    req.on('error', reject);
    req.end();
  });
}

/**
 * Adds a comment to an existing issue
 * @param {Object} params - Comment parameters
 */
async function addCommentToIssue(params) {
  const { owner, repo, token, issueNumber, comment } = params;

  const postData = JSON.stringify({
    body: comment
  });

  const options = {
    hostname: 'api.github.com',
    path: `/repos/${owner}/${repo}/issues/${issueNumber}/comments`,
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      'Content-Length': postData.length,
      'User-Agent': 'CronoHub-Test-Bot'
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 201) {
          console.log('‚úÖ Comment added to existing issue');
          resolve(JSON.parse(data));
        } else {
          reject(new Error(`Failed to add comment: ${res.statusCode}`));
        }
      });
    });

    req.on('error', reject);
    req.write(postData);
    req.end();
  });
}

// Main execution
async function main() {
  const {
    GITHUB_REPOSITORY,
    GITHUB_TOKEN,
    TEST_NAME,
    ERROR_MESSAGE,
    ERROR_STACK,
    CHROME_VERSION,
    GITHUB_RUN_ID,
    GITHUB_SHA,
    GITHUB_SERVER_URL,
    MENTION_USER
  } = process.env;

  if (!GITHUB_TOKEN) {
    console.error('‚ùå GITHUB_TOKEN is required');
    process.exit(1);
  }

  if (!GITHUB_REPOSITORY) {
    console.error('‚ùå GITHUB_REPOSITORY is required');
    process.exit(1);
  }

  const [owner, repo] = GITHUB_REPOSITORY.split('/');
  const runUrl = `${GITHUB_SERVER_URL || 'https://github.com'}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}`;

  const params = {
    owner,
    repo,
    token: GITHUB_TOKEN,
    testName: TEST_NAME || 'Unknown Test',
    errorMessage: ERROR_MESSAGE || 'No error message provided',
    errorStack: ERROR_STACK || '',
    chromeVersion: CHROME_VERSION || 'Unknown',
    runUrl,
    commitSha: GITHUB_SHA || 'unknown',
    runId: GITHUB_RUN_ID || 'unknown',
    mentionUser: MENTION_USER
  };

  try {
    // Check if similar issue exists
    console.log('üîç Checking for existing issues...');
    const existingIssue = await checkExistingIssue(params);

    if (existingIssue) {
      console.log(`üìå Found existing issue: ${existingIssue.html_url}`);

      // Add comment to existing issue
      const comment = `## üîÑ Test Failed Again

**Timestamp:** ${new Date().toISOString()}
**Commit:** ${params.commitSha}

The test is still failing with Chrome ${params.chromeVersion}.

### Error Message
\`\`\`
${params.errorMessage}
\`\`\`

[View Run Details](${runUrl})
`;

      await addCommentToIssue({
        owner,
        repo,
        token: GITHUB_TOKEN,
        issueNumber: existingIssue.number,
        comment
      });

    } else {
      // Create new issue
      console.log('üìù Creating new issue...');
      const issue = await createIssue(params);
      console.log(`‚úÖ Successfully created issue #${issue.number}`);
    }

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

// Run if executed directly
if (require.main === module) {
  main();
}

module.exports = {
  createIssue,
  checkExistingIssue,
  addCommentToIssue
};
