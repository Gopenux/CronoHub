// CronoHub - Time Tracking E2E Tests
// Author: Gopenux AI
// Copyright (c) 2026 Gopenux AI

const {
  launchBrowserWithExtension,
  setGitHubToken,
  waitForCronoHubButton,
  openCronoHubPanel,
  navigateToGitHubIssue,
  takeScreenshot
} = require('./helpers/extension-loader');

describe('Time Tracking Flow E2E Tests', () => {
  let browser;
  let page;
  let extensionId;

  jest.setTimeout(90000);

  beforeAll(async () => {
    const launch = await launchBrowserWithExtension();
    browser = launch.browser;
    page = launch.page;
    extensionId = launch.extensionId;

    await setGitHubToken(page, 'ghp_test_token_tracking', extensionId);
  });

  afterAll(async () => {
    if (browser) {
      await browser.close();
    }
  });

  test('should open panel when clicking CronoHub button', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await waitForCronoHubButton(page);

      // Click the button
      await page.click('#gtt-toggle-btn');

      // Wait for panel to appear
      await page.waitForSelector('#gtt-panel:not(.hidden)', { timeout: 5000 });

      const panelVisible = await page.$eval('#gtt-panel',
        el => !el.classList.contains('hidden')
      );

      expect(panelVisible).toBe(true);

    } catch (error) {
      await takeScreenshot(page, 'panel-open-error');
      throw error;
    }
  });

  test('should display issue information in panel', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Check if issue info is displayed
      const issueNumberExists = await page.$('.gtt-issue-number');
      const issueTitleExists = await page.$('.gtt-issue-title');

      expect(issueNumberExists).toBeTruthy();
      expect(issueTitleExists).toBeTruthy();

      // Verify issue number contains #1
      const issueNumberText = await page.$eval('.gtt-issue-number', el => el.textContent);
      expect(issueNumberText).toContain('#1');
      expect(issueNumberText).toContain('facebook/react');

    } catch (error) {
      await takeScreenshot(page, 'panel-issue-info-error');
      throw error;
    }
  });

  test('should have hours input and description textarea', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Check for hours input
      const hoursInput = await page.$('#gtt-hours');
      expect(hoursInput).toBeTruthy();

      // Check for description textarea
      const descriptionTextarea = await page.$('#gtt-description');
      expect(descriptionTextarea).toBeTruthy();

      // Check for submit button
      const submitButton = await page.$('#gtt-submit');
      expect(submitButton).toBeTruthy();

    } catch (error) {
      await takeScreenshot(page, 'panel-form-elements-error');
      throw error;
    }
  });

  test('should show error when submitting without hours', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Try to submit without entering hours
      await page.click('#gtt-submit');

      // Wait for toast error
      await page.waitForSelector('.gtt-toast.error', { timeout: 3000 });

      const toastText = await page.$eval('.gtt-toast', el => el.textContent);
      expect(toastText).toContain('Please enter hours worked');

    } catch (error) {
      await takeScreenshot(page, 'validation-no-hours-error');
      throw error;
    }
  });

  test('should show error when hours are out of range', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Enter invalid hours (too high)
      await page.type('#gtt-hours', '30');
      await page.click('#gtt-submit');

      // Wait for toast error
      await page.waitForSelector('.gtt-toast.error', { timeout: 3000 });

      const toastText = await page.$eval('.gtt-toast', el => el.textContent);
      expect(toastText).toContain('Hours must be between');

    } catch (error) {
      await takeScreenshot(page, 'validation-hours-range-error');
      throw error;
    }
  });

  test('should accept valid hours input', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Enter valid hours
      await page.type('#gtt-hours', '2.5');

      const hoursValue = await page.$eval('#gtt-hours', el => el.value);
      expect(hoursValue).toBe('2.5');

    } catch (error) {
      await takeScreenshot(page, 'hours-input-error');
      throw error;
    }
  });

  test('should accept optional description', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      const testDescription = 'Fixed bug in component rendering';
      await page.type('#gtt-description', testDescription);

      const descValue = await page.$eval('#gtt-description', el => el.value);
      expect(descValue).toBe(testDescription);

    } catch (error) {
      await takeScreenshot(page, 'description-input-error');
      throw error;
    }
  });

  test('should format comment correctly', async () => {
    // This test verifies the comment format structure
    const hours = 3;
    const description = 'Implemented new feature';

    const expectedFormat = `⏱️ **Time Tracked:** ${hours} Hours

${description}

---
<sub>**Registrado con CronoHub** by Gopenux AI</sub>`;

    expect(expectedFormat).toContain('⏱️');
    expect(expectedFormat).toContain('Time Tracked:');
    expect(expectedFormat).toContain(description);
    expect(expectedFormat).toContain('CronoHub');
  });

  test('should close panel when clicking close button', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Panel should be visible
      let panelVisible = await page.$eval('#gtt-panel',
        el => !el.classList.contains('hidden')
      );
      expect(panelVisible).toBe(true);

      // Click close button
      await page.click('#gtt-close');
      await page.waitForTimeout(500);

      // Panel should be hidden
      panelVisible = await page.$eval('#gtt-panel',
        el => !el.classList.contains('hidden')
      );
      expect(panelVisible).toBe(false);

    } catch (error) {
      await takeScreenshot(page, 'panel-close-error');
      throw error;
    }
  });

  test('should display user name in panel', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Check for user info section
      const userNameElement = await page.$('.gtt-user-name');
      expect(userNameElement).toBeTruthy();

      const userName = await page.$eval('.gtt-user-name', el => el.textContent);
      expect(userName).toBeTruthy();
      expect(userName.length).toBeGreaterThan(0);

    } catch (error) {
      await takeScreenshot(page, 'panel-user-info-error');
      throw error;
    }
  });

  test('should show loading state when submitting', async () => {
    try {
      await navigateToGitHubIssue(page, 'facebook', 'react', 1);
      await page.waitForTimeout(2000);
      await openCronoHubPanel(page);

      // Mock fetch to delay response
      await page.evaluateOnNewDocument(() => {
        window.fetch = async (url, options) => {
          await new Promise(resolve => setTimeout(resolve, 2000));
          return {
            ok: true,
            json: async () => ({ id: 1 })
          };
        };
      });

      // Enter valid data
      await page.type('#gtt-hours', '2');

      // Submit
      await page.click('#gtt-submit');

      // Check if button is disabled during loading
      await page.waitForTimeout(500);

      const buttonDisabled = await page.$eval('#gtt-submit', el => el.disabled);
      expect(buttonDisabled).toBe(true);

      // Check if loading text is shown
      const buttonText = await page.$eval('#gtt-submit', el => el.textContent);
      expect(buttonText).toContain('Logging');

    } catch (error) {
      await takeScreenshot(page, 'loading-state-error');
      throw error;
    }
  });

  test('should handle different hour formats', async () => {
    const testCases = [
      { input: '1', expected: '1' },
      { input: '0.25', expected: '0.25' },
      { input: '2.5', expected: '2.5' },
      { input: '8', expected: '8' },
      { input: '24', expected: '24' }
    ];

    for (const testCase of testCases) {
      try {
        await navigateToGitHubIssue(page, 'facebook', 'react', 1);
        await page.waitForTimeout(2000);
        await openCronoHubPanel(page);

        // Clear previous input
        await page.evaluate(() => {
          document.getElementById('gtt-hours').value = '';
        });

        // Enter hours
        await page.type('#gtt-hours', testCase.input);

        const value = await page.$eval('#gtt-hours', el => el.value);
        expect(value).toBe(testCase.expected);

        // Close panel for next iteration
        await page.click('#gtt-close');
        await page.waitForTimeout(500);

      } catch (error) {
        await takeScreenshot(page, `hour-format-${testCase.input}-error`);
        throw error;
      }
    }
  });
});
