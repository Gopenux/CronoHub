name: Daily Chrome Compatibility Tests

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  test:
    name: E2E Tests (Puppeteer Chromium)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Using Puppeteer's bundled Chromium for consistent behavior
    # No need for matrix since we're not testing different Chrome versions

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üß™ Run Unit Tests
        id: unit-tests
        continue-on-error: true
        run: npm run test:unit

      - name: üåê Run E2E Tests
        id: e2e-tests
        continue-on-error: true
        run: npm run test:e2e
        env:
          # CI environment automatically uses new headless mode + bundled Chromium
          CI: true

      - name: üì∏ Upload Screenshots on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ github.run_id }}
          path: tests/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      - name: üìä Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: |
            coverage/
            tests/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      - name: üêõ Create Issue on Test Failure
        if: failure() && github.event_name == 'schedule'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TEST_NAME: ${{ github.job }}
          CHROME_VERSION: Puppeteer Chromium
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          MENTION_USER: ${{ github.repository_owner }}
          ERROR_MESSAGE: |
            Test suite failed with Puppeteer Chromium
            Job: ${{ github.job }}
            Run ID: ${{ github.run_id }}
          ERROR_STACK: |
            Check the GitHub Actions logs for detailed error information.
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: node tests/scripts/create-failure-issue.js

      - name: ‚úÖ Mark tests as passed
        if: success()
        run: echo "All tests passed successfully with Puppeteer Chromium"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: üìä Generate Summary
        run: |
          echo "## üß™ Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** Puppeteer Chromium (bundled)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "‚úÖ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some tests failed. Check the job logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Fail workflow if tests failed
        if: needs.test.result != 'success'
        run: exit 1
